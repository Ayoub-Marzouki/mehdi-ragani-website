<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" th:href="@{/css/sharedstyle.css}">
    <link rel="stylesheet" th:href="@{/css/checkout.css}">
    
    <script th:src="@{|https://www.paypal.com/sdk/js?client-id=${paypalClientId}|}"></script>
</head>

<body th:replace="layouts/main-layout :: main-layout(~{::body/content()})">
    <div class="flex-main">
        <header id="checkout">
            <h1>Checkout</h1>
            <p>Currently: <span th:text="${cart.items.size()}"></span> product(s) in your cart.</p>
            
            <div id="paypal-buttons-container"></div>

            <div id="payment-message" style="color: red; margin-top: 10px;"></div>
        </header>

        <div id="cart-items">
            <header id="added-artworks">
                <h1>Artworks</h1>
                <h3 style="text-align:center; margin:2%;">
                    Total: <span th:text="${#numbers.formatDecimal(total, 1, 2)}"></span> 
                    <span th:text="${currency}"></span>
                </h3>
                <a th:href="@{/cart}">Back to cart</a>
                <section class="flex" th:each="item : ${cart.items}">
                    <figure>
                        <img class="artwork-image" th:src="${item.artwork.getMainImagePath()}" alt="Artwork Image">
                        <figcaption class="artwork-title" th:text="${item.artwork.title}"></figcaption>
                        <figcaption class="artwork-price">
                            <span th:text="${#numbers.formatDecimal(item.getLineTotal(), 1, 2)}"></span>
                            <span th:text="${currency}"></span>
                        </figcaption>
                    </figure>
                </section>
            </header>
        </div>
    </div>

<script th:inline="javascript">
    // Storing our internal orderId after it's created
    let ourOrderId = null; 

    paypal.Buttons({
        enableStandardCardFields: true,
        style: {
            layout: 'vertical',
            color: 'black',
            shape: 'rect',
            label: 'pay'
        },
        // ----------------------------------------------------------------
        // 1. CREATE ORDER: Called when the user clicks the PayPal button
        // ----------------------------------------------------------------
        createOrder: function() {
            console.log("Creating order...");
            const messageDiv = document.getElementById('payment-message');
            messageDiv.innerText = "Connecting to PayPal...";

            // Use the modern 'fetch' API to call your Spring Boot backend
            return fetch('/api/paypal/create-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Backend could not create the order.");
                }
                return response.json();
            })
            .then(order => {
                console.log("Order created on our backend:", order);
                // Store our internal order ID for the capture step
                ourOrderId = order.ourOrderId; 
                // Return PayPal's order ID to the PayPal SDK
                return order.paypalOrderId; 
            })
            .catch(error => {
                console.error("Error during createOrder:", error);
                messageDiv.innerText = "Could not initiate PayPal Checkout. Please try again.";
            });
        },

        // -----------------------------------------------------------------
        // 2. ON APPROVE: Called after the user approves the payment in the
        //    PayPal popup.
        // -----------------------------------------------------------------
        onApprove: function(data, actions) {
            console.log("Payment approved by user. Capturing transaction...");
            const messageDiv = document.getElementById('payment-message');
            messageDiv.innerText = "Finalizing your payment, please wait...";

            // 'data.orderID' is the PayPal order ID from the approval
            // 'ourOrderId' is the one we stored in the createOrder step
            const paypalOrderId = data.orderID;
            
            // Call your Spring Boot backend to capture the order
            return fetch(`/api/paypal/capture-order?paypalOrderId=${paypalOrderId}&ourOrderId=${ourOrderId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Backend could not capture the payment.");
                }
                return response.json();
            })
            .then(captureData => {
                console.log("Capture successful:", captureData);

                window.location.href = '/payment/payment-completed?orderId=' + ourOrderId;
            })
            .catch(error => {
                console.error("Error during onApprove:", error);
                messageDiv.innerText = "Payment failed. Please try again or contact support.";
                window.location.href = '/payment/payment-failed';
            });
        },
        
        // Optional: Handle errors during the PayPal flow
        onError: function(err) {
            console.error('An error occurred with the PayPal button:', err);
            const messageDiv = document.getElementById('payment-message');
            messageDiv.innerText = "An error occurred. Please refresh the page and try again.";
        }

    }).render('#paypal-buttons-container'); // Render the button in our container div
</script>
</body>
</html>