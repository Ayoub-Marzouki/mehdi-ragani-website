<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" th:href="@{/css/sharedstyle.css}">
    <link rel="stylesheet" th:href="@{/css/checkout.css}">
    
    <script th:src="@{|https://www.paypal.com/sdk/js?client-id=${paypalClientId}|}"></script>
</head>

<body th:replace="layouts/main-layout :: main-layout(~{::body/content()})">
    <div id="messages"></div>
    <div class="flex-main">
        <header id="checkout">
            <h1>Checkout</h1>
            <p>Currently: <span th:text="${cart.items.size()}"></span> product(s) in your cart.</p>
            
            <div id="paypal-buttons-container"></div>
        </header>

        <div id="cart-items">
            <header id="added-artworks">
                <h1>Artworks</h1>
                <h3 style="text-align:center; margin:2%;">
                    Total: <span th:text="${#numbers.formatDecimal(total, 1, 2)}"></span> 
                    <span th:text="${currency}"></span>
                </h3>
                <a th:href="@{/cart}">Back to cart</a>
                <section class="flex" th:each="item : ${cart.items}">
                    <figure>
                        <img class="artwork-image" th:src="${item.artwork.getMainImagePath()}" alt="Artwork Image">
                        <figcaption class="artwork-title" th:text="${item.artwork.title}"></figcaption>
                        <figcaption class="artwork-price">
                            <span th:text="${#numbers.formatDecimal(item.getLineTotal(), 1, 2)}"></span>
                            <span th:text="${currency}"></span>
                        </figcaption>
                    </figure>
                </section>
                <!-- Prints Section -->
                <h1>Prints</h1>
                <section class="flex" th:each="item : ${cart.printItems}">
                    <figure>
                        <img class="artwork-image" th:src="${item.print.mainImagePath}" alt="Print Image">
                        <figcaption class="artwork-title" th:text="${item.print.title}"></figcaption>
                        <figcaption class="artwork-price">
                            <span th:text="${#numbers.formatDecimal(item.lineTotal, 1, 2)}"></span>
                            <span th:text="${currency}"></span>
                        </figcaption>
                        <div class="print-details">
                            <p><b>Type:</b> <span th:text="${item.type}"></span></p>
                            <p><b>Size:</b> <span th:text="${item.size}"></span></p>
                            <p><b>Framing:</b> <span th:text="${item.framing}"></span></p>
                            <p><b>Quantity:</b> <span th:text="${item.quantity}"></span></p>
                        </div>
                    </figure>
                </section>
            </header>
        </div>
    </div>

<script th:inline="javascript">
    // Message display logic
    function showMessage(text, tag = 'info') {
        const messagesDiv = document.getElementById('messages');
        const msg = document.createElement('div');
        msg.className = 'message';
        msg.setAttribute('data-tags', tag);
        msg.textContent = text;
        messagesDiv.appendChild(msg);
        setTimeout(() => { msg.style.opacity = 1; }, 0);
        setTimeout(() => { msg.style.opacity = 0; }, 4000);
        setTimeout(() => { msg.remove(); }, 5000);
    }

    // Storing our internal orderId after it's created
    let ourOrderId = null; 

    paypal.Buttons({
        enableStandardCardFields: true,
        style: {
            layout: 'vertical',
            color: 'black',
            shape: 'rect',
            label: 'pay'
        },
        // ----------------------------------------------------------------
        // 1. CREATE ORDER: Called when the user clicks the PayPal button
        // ----------------------------------------------------------------
        createOrder: function() {
            showMessage('Connecting to PayPal...', 'info');
            return fetch('/api/paypal/create-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
            .then(response => response.json().then(data => ({ status: response.status, data })))
            .then(({ status, data }) => {
                if (status !== 200 || !data.paypalOrderId) {
                    const errorMsg = data && data.error ? data.error : 'Could not initiate PayPal Checkout. Please try again.';
                    showMessage(errorMsg, 'error');
                    throw new Error(errorMsg);
                }
                ourOrderId = data.ourOrderId;
                return data.paypalOrderId;
            })
            .catch(error => {
                // Error already shown above
                return undefined; // Do not return an order id to PayPal
            });
        },

        // -----------------------------------------------------------------
        // 2. ON APPROVE: Called after the user approves the payment in the
        //    PayPal popup.
        // -----------------------------------------------------------------
        onApprove: function(data, actions) {
            showMessage('Finalizing your payment, please wait...', 'info');
            const paypalOrderId = data.orderID;
            
            // Call your Spring Boot backend to capture the order
            return fetch(`/api/paypal/capture-order?paypalOrderId=${paypalOrderId}&ourOrderId=${ourOrderId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Backend could not capture the payment.");
                }
                return response.json();
            })
            .then(captureData => {
                showMessage('Payment successful! Redirecting...', 'success');
                window.location.href = '/payment/payment-completed?orderId=' + ourOrderId;
            })
            .catch(error => {
                showMessage('Payment failed. Please try again or contact support.', 'error');
                // Use flash attribute via POST, not query parameter
                fetch('/payment/store-failure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'errorMsg=' + encodeURIComponent(error && error.message ? error.message : 'Payment failed')
                }).then(() => {
                    window.location.href = '/payment/payment-failed';
                });
            });
        },
        
        // Optional: Handle errors during the PayPal flow
        onError: function(err) {
            showMessage('An error occurred. Please refresh the page and try again.', 'error');
        }

    }).render('#paypal-buttons-container'); // Render the button in our container div
</script>
</body>
</html>